name: Build and Deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  REGISTRY: ${{ secrets.ALIYUN_REGISTRY }}
  NAMESPACE: ${{ secrets.ALIYUN_NAMESPACE }}
  IMAGE_NAME_BACKEND: daer-novel-backend
  IMAGE_NAME_FRONTEND: daer-novel-frontend

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Aliyun ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: Extract metadata (tags, labels) for Backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME_BACKEND }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha

      - name: Extract metadata (tags, labels) for Frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME_FRONTEND }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/backend/Dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/frontend/Dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_API_URL=https://novel.daerai.com

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy docker-compose.prod.yml to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: "docker-compose.prod.yml"
          target: "/www/wwwroot/novel.daerai.com/"
          strip_components: 0
          overwrite: true

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        env:
          ALIYUN_REGISTRY: ${{ secrets.ALIYUN_REGISTRY }}
          ALIYUN_NAMESPACE: ${{ secrets.ALIYUN_NAMESPACE }}
          ALIYUN_USERNAME: ${{ secrets.ALIYUN_USERNAME }}
          ALIYUN_PASSWORD: ${{ secrets.ALIYUN_PASSWORD }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          command_timeout: 30m
          timeout: 30m
          envs: ALIYUN_REGISTRY,ALIYUN_NAMESPACE,ALIYUN_USERNAME,ALIYUN_PASSWORD
          script: |
            # Fix locale warnings permanently
            export LC_ALL=C
            export LANG=C
            
            mkdir -p /www/wwwroot/novel.daerai.com/
            cd /www/wwwroot/novel.daerai.com/
            
            # Login to Aliyun ACR on the server
            echo "$ALIYUN_PASSWORD" | docker login "$ALIYUN_REGISTRY" --username "$ALIYUN_USERNAME" --password-stdin

            # Update .env file with Registry info ONLY if missing (server-managed mode)
            if [ ! -f .env ]; then
              touch .env
            fi
            
            # Helper function to update or append env var
            update_env() {
              key=$1
              val=$2
              if ! grep -q "^$key=" .env; then
                echo "$key=$val" >> .env
              fi
            }

            update_env "ALIYUN_REGISTRY" "$ALIYUN_REGISTRY"
            update_env "ALIYUN_NAMESPACE" "$ALIYUN_NAMESPACE"

            
            # Export for current session just in case
            export ALIYUN_REGISTRY=$ALIYUN_REGISTRY
            export ALIYUN_NAMESPACE=$ALIYUN_NAMESPACE
            
            # Stop services first
            docker compose -f docker-compose.prod.yml down
            
            # Remove old images to force pull latest
            docker rmi ${ALIYUN_REGISTRY}/${ALIYUN_NAMESPACE}/daer-novel-backend:latest || true
            docker rmi ${ALIYUN_REGISTRY}/${ALIYUN_NAMESPACE}/daer-novel-frontend:latest || true
            
            # Pull latest images
            docker compose -f docker-compose.prod.yml pull
            
            # Start services
            docker compose -f docker-compose.prod.yml up -d
            
            # Cleanup unused images
            docker image prune -f
